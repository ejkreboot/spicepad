<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ngspice WASM Test</title>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #1a1a2e;
      color: #eee;
    }
    h1 {
      color: #00d9ff;
    }
    .container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }
    @media (max-width: 900px) {
      .container {
        grid-template-columns: 1fr;
      }
    }
    .panel {
      background: #16213e;
      border-radius: 8px;
      padding: 20px;
      border: 1px solid #0f3460;
    }
    h2 {
      margin-top: 0;
      color: #00d9ff;
      font-size: 1.1rem;
    }
    textarea {
      width: 100%;
      height: 300px;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 13px;
      background: #0d1b2a;
      color: #7ec8e3;
      border: 1px solid #0f3460;
      border-radius: 4px;
      padding: 12px;
      resize: vertical;
    }
    button {
      background: #00d9ff;
      color: #1a1a2e;
      border: none;
      padding: 12px 24px;
      font-size: 14px;
      font-weight: 600;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 12px;
      transition: background 0.2s;
    }
    button:hover {
      background: #00b8d9;
    }
    button:disabled {
      background: #555;
      cursor: not-allowed;
    }
    #output {
      width: 100%;
      height: 300px;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 12px;
      background: #0d1b2a;
      color: #98c379;
      border: 1px solid #0f3460;
      border-radius: 4px;
      padding: 12px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    #plot {
      width: 100%;
      height: 400px;
      margin-top: 20px;
      border-radius: 8px;
      overflow: hidden;
    }
    .status {
      padding: 8px 12px;
      border-radius: 4px;
      margin-bottom: 12px;
      font-size: 13px;
    }
    .status.loading { background: #3d3d00; color: #ffff00; }
    .status.ready { background: #003d00; color: #00ff00; }
    .status.error { background: #3d0000; color: #ff6666; }
    .status.running { background: #003d3d; color: #00ffff; }
    .examples {
      margin-top: 12px;
    }
    .examples button {
      background: #0f3460;
      color: #00d9ff;
      padding: 8px 12px;
      font-size: 12px;
      margin-right: 8px;
      margin-top: 8px;
    }
    .examples button:hover {
      background: #1a4a7a;
    }
  </style>
</head>
<body>
  <h1>‚ö° ngspice WASM Test Bench</h1>
  
  <div id="status" class="status ready">Ready to simulate</div>
  
  <div class="container">
    <div class="panel">
      <h2>üìù Netlist Input</h2>
      <textarea id="netlist">RC Low-Pass Filter - Transient Analysis
* Simple RC filter with step input

V1 in 0 PULSE(0 5 0 1n 1n 5m 10m)
R1 in out 1k
C1 out 0 1u

.tran 100u 20m
.control
run
wrdata output.txt v(in) v(out)
.endc
.end
</textarea>
      <div class="examples">
        <button onclick="loadExample('rc')">RC Filter</button>
        <button onclick="loadExample('rlc')">RLC Resonance</button>
        <button onclick="loadExample('diode')">Diode Rectifier</button>
        <button onclick="loadExample('opamp')">Op-Amp Inverter</button>
      </div>
      <button id="runBtn" onclick="runSimulation()">‚ñ∂ Run Simulation</button>
    </div>
    
    <div class="panel">
      <h2>üìü Console Output</h2>
      <div id="output">Ready. Enter a netlist and click Run.</div>
    </div>
  </div>
  
  <div class="panel" style="margin-top: 20px;">
    <h2>üìà Simulation Results</h2>
    <div id="plot"></div>
  </div>

  <script>
    // Example circuits
    const examples = {
      rc: `RC Low-Pass Filter - Transient Analysis
* Simple RC filter with step input

V1 in 0 PULSE(0 5 0 1n 1n 5m 10m)
R1 in out 1k
C1 out 0 1u

.tran 100u 20m
.control
run
wrdata output.txt v(in) v(out)
.endc
.end`,

      rlc: `RLC Resonant Circuit
* Damped oscillation demo

V1 in 0 PULSE(0 10 0 1n 1n 1m 100m)
R1 in n1 100
L1 n1 out 10m
C1 out 0 100n

.tran 10u 10m
.control
run
wrdata output.txt v(in) v(out)
.endc
.end`,

      diode: `Half-Wave Rectifier
* Diode rectifier with RC smoothing

V1 in 0 SIN(0 10 1k)
D1 in out DMOD
R1 out 0 1k
C1 out 0 10u

.model DMOD D(Is=1e-14 Rs=10 N=1.8)

.tran 10u 5m
.control
run
wrdata output.txt v(in) v(out)
.endc
.end`,

      opamp: `Inverting Op-Amp
* Simple inverting amplifier (ideal op-amp model)

V1 in 0 SIN(0 0.5 1k)
Vcc vcc 0 DC 12
Vee vee 0 DC -12

R1 in ni 10k
R2 ni out 47k

* Ideal op-amp as VCVS
E1 out 0 0 ni 100000

.tran 10u 3m
.control
run
wrdata output.txt v(in) v(out)
.endc
.end`
    };
    
    window.loadExample = (name) => {
      document.getElementById('netlist').value = examples[name];
    };
    
    const outputEl = document.getElementById('output');
    const statusEl = document.getElementById('status');
    const runBtn = document.getElementById('runBtn');
    
    let spinitContent = null;
    let worker = null;
    
    // Load spinit file
    fetch('spinit')
      .then(r => r.text())
      .then(text => {
        spinitContent = text;
        console.log('Loaded spinit');
      })
      .catch(err => {
        console.warn('Could not load spinit:', err);
      });
    
    window.runSimulation = () => {
      const netlist = document.getElementById('netlist').value;
      
      // Update UI
      outputEl.textContent = 'Starting simulation...\n';
      statusEl.className = 'status running';
      statusEl.textContent = '‚è≥ Running simulation...';
      runBtn.disabled = true;
      
      // Kill any existing worker
      if (worker) {
        worker.terminate();
        worker = null;
      }
      
      // Create fresh worker
      worker = new Worker('ngspice-worker.js');
      
      let outputBuffer = '';
      
      worker.onmessage = (e) => {
        const { type, text, message, outputData, stdout, stderr, stack } = e.data;
        
        switch (type) {
          case 'ready':
            // Worker is ready, send the simulation request
            worker.postMessage({ 
              type: 'run', 
              netlist,
              spinit: spinitContent
            });
            break;
            
          case 'status':
            outputBuffer += `[status] ${text}\n`;
            outputEl.textContent = outputBuffer;
            break;
            
          case 'stdout':
            outputBuffer += text + '\n';
            outputEl.textContent = outputBuffer;
            outputEl.scrollTop = outputEl.scrollHeight;
            break;
            
          case 'stderr':
            outputBuffer += `[stderr] ${text}\n`;
            outputEl.textContent = outputBuffer;
            outputEl.scrollTop = outputEl.scrollHeight;
            break;
            
          case 'complete':
            statusEl.className = 'status ready';
            statusEl.textContent = '‚úì Simulation complete';
            runBtn.disabled = false;
            
            if (outputData) {
              outputBuffer += '\n--- Output Data ---\n';
              outputBuffer += outputData.substring(0, 3000);
              if (outputData.length > 3000) {
                outputBuffer += `\n... (truncated, ${outputData.length} bytes total)`;
              }
              outputEl.textContent = outputBuffer;
              plotResults(outputData);
            } else {
              outputBuffer += '\n[Note] No output.txt file generated\n';
              outputEl.textContent = outputBuffer;
              // Try to parse stdout for .print output
              if (stdout) {
                tryParsePrintOutput(stdout);
              }
            }
            
            // Clean up worker
            worker.terminate();
            worker = null;
            break;
            
          case 'error':
            statusEl.className = 'status error';
            statusEl.textContent = '‚úó Simulation failed';
            runBtn.disabled = false;
            
            outputBuffer += `\n[ERROR] ${message}\n`;
            if (stack) {
              outputBuffer += stack + '\n';
            }
            outputEl.textContent = outputBuffer;
            
            // Clean up worker
            worker.terminate();
            worker = null;
            break;
        }
      };
      
      worker.onerror = (err) => {
        statusEl.className = 'status error';
        statusEl.textContent = '‚úó Worker error';
        runBtn.disabled = false;
        
        outputEl.textContent = outputBuffer + `\n[WORKER ERROR] ${err.message}\n`;
        
        worker.terminate();
        worker = null;
      };
    };
    
    function tryParsePrintOutput(stdout) {
      // Try to extract data from .print output in stdout
      const lines = stdout.split('\n');
      const dataLines = lines.filter(line => {
        const trimmed = line.trim();
        // Look for lines that start with a number (data rows)
        return /^\d/.test(trimmed) || /^-?\d*\.\d+/.test(trimmed);
      });
      
      if (dataLines.length > 0) {
        plotResults(dataLines.join('\n'));
      }
    }
    
    function plotResults(data) {
      const lines = data.trim().split('\n').filter(l => {
        if (!l || l.startsWith('#') || l.startsWith('N')) return false;
        // Skip header-like lines
        if (l.includes('Index') || l.includes('time')) return false;
        return true;
      });
      
      if (lines.length === 0) {
        console.log('No data to plot');
        return;
      }
      
      const time = [];
      const signals = {};
      
      // Parse wrdata output format: time val1 val2 ...
      lines.forEach((line) => {
        const parts = line.trim().split(/\s+/).map(parseFloat);
        if (parts.length >= 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
          time.push(parts[0]);
          parts.slice(1).forEach((val, i) => {
            const sigName = i === 0 ? 'V(in)' : i === 1 ? 'V(out)' : `Signal ${i + 1}`;
            if (!signals[sigName]) signals[sigName] = [];
            signals[sigName].push(val);
          });
        }
      });
      
      if (time.length === 0) {
        console.log('Could not parse data');
        return;
      }
      
      // Create Plotly traces
      const colors = ['#00d9ff', '#ff6b6b', '#4ecdc4', '#ffe66d'];
      const traces = Object.entries(signals).map(([name, values], i) => ({
        x: time,
        y: values,
        type: 'scatter',
        mode: 'lines',
        name: name,
        line: { color: colors[i % colors.length], width: 2 }
      }));
      
      const layout = {
        paper_bgcolor: '#16213e',
        plot_bgcolor: '#0d1b2a',
        font: { color: '#eee' },
        xaxis: { 
          title: 'Time (s)',
          gridcolor: '#0f3460',
          zerolinecolor: '#0f3460'
        },
        yaxis: { 
          title: 'Voltage (V)',
          gridcolor: '#0f3460',
          zerolinecolor: '#0f3460'
        },
        margin: { t: 40, r: 40, b: 60, l: 60 },
        legend: { 
          x: 1, 
          xanchor: 'right', 
          y: 1,
          bgcolor: 'rgba(22, 33, 62, 0.8)'
        }
      };
      
      Plotly.newPlot('plot', traces, layout, { responsive: true });
    }
  </script>
</body>
</html>